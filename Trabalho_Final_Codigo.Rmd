---
title: "Trabalho Final"
author: "Alunas: Daniele ..., Jessica Hemily de Sá Gonçalves, Larissa ..."
date: "04/03/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Pacotes
```{r message=FALSE, warning=FALSE}
library(psych)
library(summarytools)
library(performance)
library(MASS)
library(dplyr)
library(rstatix)
library(lmtest)
library(car)
library(ggpubr)
library(hnp)
```

### Base de dados a ser analisada
```{r }

df <- read.csv('https://raw.githubusercontent.com/JessicaHemily/COMP_1/main/LeukocyteProfiles.csv/LeukocyteProfiles.csv', 
				  header = TRUE,
				  sep = ',')

head(df)

#df_2 <- df[df$Species == "Calidris temminckii",]
#linha <- nrow(df_2)
#linha


```

### **1. Compreensão dos dados**

**VARIÁVEIS**

**FatScore:** Escore de gordura que varia de 0 a 8;

<img src="Fat-score-stages-in-birds-fat-classes-0-to-8-fat-stippled-areas.png" width="400" height="450">


**BodyMass:** Massa do pássaro;

**Heterophils:** Heterófilos são fagócitos-chaves fundamentais para a defesa imunológica das aves. Eles se ligam e detectam patógenos invasores através do uso de receptores Toll-like (TLRs), receptores Fc e receptores de complemento;

**Lymphocytes:** Linfócitos são um tipo de leucócito ou glóbulo branco do sangue, responsáveis pelo reconhecimento e destruição de micro-organismos infecciosos como bactériase vírus;

**Eosinophils:** 

**Monocytes:**

**Basophils:**

**HLRatio:**

### Resumo dos Dados

```{r}
glimpse(df)
summary(df)
```
### Variável de Interesse

A variável que se deseja modelar é a FatScore.

```{r}

hist(df$FatScore)

```
   
### Espécies e número de indíviduos
```{r}
cbind(table(df$Species))
```
### Outliers

```{r fig.align='center', fig.height=10, fig.width=15, message=FALSE, warning=FALSE}
par(mfrow = c(2,4))
for (coluna in c(2:9)) {
  variavel <- names(df)[coluna]
  boxplot(df[,coluna],main = variavel)
}
```

Devido as diferentes espécies em estudo, é esperado que haja variabilidade dos dados.

### Levantamente de idéias 

  * A variável resposta é do tipo discreta;
  * Descartamos a regressão linear lm(), devido a variável resposta não ser contínua;
  * Talvez seja interessante agregar o gênero da variável "Species" (retirar a espécie da nomenclatura binomial) para a criação do moledo.
   
### Criar a variável "Genero" apartir da "Species"
```{r}

# Função para extrair a primeira palavra de uma string
extrair_primeira_palavra <- function(string) {
  palavras <- strsplit(string, " ")[[1]]
  primeira_palavra <- palavras[1]
  return(primeira_palavra)
}

df$Genero <- sapply(df$Species, extrair_primeira_palavra)
```

   
### Genero e número de indíviduos
```{r}
cbind(table(df$Genero))
```
   
   
### Outliers

Criação de boxplot por genero

```{r fig.align='center', fig.height=25, fig.width=15, message=FALSE, warning=FALSE}

par(mfrow = c(8,1))
for (coluna in c(2:9)) {
  variavel <- names(df)[coluna]
  boxplot(df[,coluna] ~df[,10],main = variavel)
}

```

Considerando o tamanho da base de dados, considera-se que haja poucos outliers (**subjetivamente**).

### NAs na base?

```{r}

df_na <- df[!complete.cases(df),]
head(df_na)   

```
```{r}
linhas_na <- nrow(df_na)
linhas_df <- nrow(df)
linhas_na

cat("A base de dados possui",linhas_df, "observacoes e",linhas_na, "linhas contendo ao menos um NA")
```
   
### Identificar as variáveis que possuem NAs

```{r}

cbind(colSums(is.na(df)))

```
   
### Cálculo da mediana de bodymass para substituição dos valore NAs

```{r}

#median_bm <- median(df$BodyMass,by(df$Species_2),na.rm = TRUE)
#median_bm

# Função para substituir os valores NA pela mediana, agrupada pelo Genero
substituir_na_pela_mediana <- function(valor) {
  mediana <- median(valor, na.rm = TRUE)
  valor[is.na(valor)] <- mediana
  return(valor)
}
```

### Substituir os NAs pela mediana
```{r}
#df$BodyMass <- (replace(x = df$BodyMass,
 #                              list = is.na(df$BodyMass),
  #                             values = median_bm)
   #                             )

#Substituição levando em consideração o Genero
df$BodyMass <- ave(df$BodyMass, df$Genero, FUN = substituir_na_pela_mediana)

```

### Há multicolinearidade entre as variáveis preditoras?

```{r fig.align='center', fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
pairs.panels(df[,-1])

```

Há multicolinearidade (| r | > 0,8) entre as variáveis:

  * "Heterophils" e "Lymphocytis", devido r = - 0,91;
  
  * "Heterophils" e "HLRatio", devido r = 0,82;
  
  * "Lymphocytis" e "HLRatio, devido r = - 0,79. 

### **2 Criação do Modelo**

```{r}

modelo <- glm(FatScore ~ BodyMass + Heterophils + Eosinophils + Monocytes + Basophils + Genero, data = df)
  
modelo

```

```{r fig.align='center', fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
par(mfrow = c(2,2))
plot(modelo)
```

```{r}
step(modelo)

hist(modelo$residuals)

summary(modelo)

anova(modelo)

AIC(modelo)

```


```{r fig.align='center', fig.height=8, fig.width=8, message=FALSE, warning=FALSE}

modelo_2 <- glm(formula = FatScore ~ Monocytes + Genero, data = df)

par(mfrow=c(2,2))
plot(modelo_2)

```


```{r}

hnp::hnp(modelo_2$residuals)


#aggregate(HLRatio ~ Species, data = df, mean)

```

















































